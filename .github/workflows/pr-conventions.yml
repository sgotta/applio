name: PR Conventions

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-branch-name:
    name: Validate branch name
    runs-on: ubuntu-latest
    # Skip for PRs from protected branches (development → staging, staging → main)
    if: >-
      github.head_ref != 'development' &&
      github.head_ref != 'staging'
    steps:
      - name: Check branch naming convention
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch name: $BRANCH"

          if [[ "$BRANCH" =~ ^(feature|fix|chore|refactor|docs|hotfix)/ ]]; then
            echo "✅ Branch name '$BRANCH' follows naming conventions."
          else
            echo "::error::Branch name '$BRANCH' doesn't follow naming conventions."
            echo ""
            echo "Expected format: <prefix>/<description>"
            echo ""
            echo "  Prefix       | Use"
            echo "  -------------|------------------------------------------"
            echo "  feature/*    | New functionality"
            echo "  fix/*        | Bug fix"
            echo "  chore/*      | Maintenance, dependencies, config"
            echo "  refactor/*   | Refactoring without behavior change"
            echo "  docs/*       | Documentation only"
            echo "  hotfix/*     | Urgent production fix (targets main)"
            echo ""
            echo "Examples: feature/add-dark-mode, fix/login-redirect, chore/update-deps"
            exit 1
          fi

  validate-pr-title:
    name: Validate PR title
    runs-on: ubuntu-latest
    steps:
      - name: Check conventional commit format
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR title: $TITLE"

          if [[ "$TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?:\ .+ ]]; then
            echo "✅ PR title follows conventional commits format."
          else
            echo "::error::PR title doesn't follow conventional commits format."
            echo ""
            echo "Expected format: <type>(<optional scope>): <description>"
            echo ""
            echo "  Type       | Use"
            echo "  -----------|------------------------------------------"
            echo "  feat       | New feature"
            echo "  fix        | Bug fix"
            echo "  docs       | Documentation only"
            echo "  style      | Code style (formatting, semicolons, etc.)"
            echo "  refactor   | Refactoring without behavior change"
            echo "  perf       | Performance improvement"
            echo "  test       | Adding or updating tests"
            echo "  build      | Build system or dependencies"
            echo "  ci         | CI/CD configuration"
            echo "  chore      | Maintenance tasks"
            echo "  revert     | Revert a previous commit"
            echo ""
            echo "Examples:"
            echo "  feat: add dark mode toggle"
            echo "  fix(auth): resolve OAuth redirect loop"
            echo "  ci: add E2E smoke tests to staging workflow"
            exit 1
          fi
